# æ‰“å°çœ¼åº•æŠ¥å‘Šå®Œæ•´æŠ¥å‘Š

**é¹°ç³åŒ»ç–—è§†ç½‘è†œæ£€æŸ¥æŠ¥å‘Š**

æ£€æŸ¥å·ï¼š25838277

ä½“æ£€å·ï¼š8991424304354

```shell
{
    "0": "/data/ikang/pdf_medical/25838277-8991424304354-251119104809-complete.pdf", 
    "command": "/opt/phantomjs /opt/print.js 'https://pe.airdoc.com/pc-v2/print-ytmedical/a2V5LWJqajY4ZDUzNzVjajQ4b3owdXI0Zy1qMTEzbGF0dDd0HJQ%2FlLD252wJGEObCHR0lRlddvWTUjJS9adzx6sPSJ59BHpe?language=zh_CN' '/data/ikang/pdf_medical' '25838277-8991424304354-251119104809-complete.pdf' 'Airdocé¹°ç³' '%E9%BB%84%E6%B3%BD%E6%A0%A1 8991424304354' 'æŠ¥å‘Šå’¨è¯¢: 400-100-3999' '0.8'", 
    "strlen": 1140937, 
    "file_exist": true
}
```

https://pe.airdoc.com/pc-v2/print-ytmedical/a2V5LWJqajY4ZDUzNzVjajQ4b3owdXI0Zy1qMTEzbGF0dDd0HJQ%2FlLD252wJGEObCHR0lRlddvWTUjJS9adzx6sPSJ59BHpe?language=zh_CN%27%20%27/data/ikang/pdf_medical%27%20%2725838277-8991424304354-251119104809-complete.pdf

**é£é™©è¯„ä¼°æŠ¥å‘Š**

æ£€æŸ¥å·ï¼š25838277

ä½“æ£€å·ï¼š8991424304354

```shell
{
    "0": "/data/ikang/pdf_medical/25838277-8991424304354-251119104809-complete-health.pdf", 
    "command": "/opt/phantomjs /opt/print.js 'https://pe.airdoc.com/pc-v2/ytHeathyPdfPE?en_check_id=a2V5LWJqajY4ZDUzNzVjajQ4b3owdXI0Zy1qMTEzbGF0dDd0HJQ%2FlLD252wJGEObCHR0lRlddvWTUjJS9adzx6sPSJ59BHpe&language=zh_CN' '/data/ikang/pdf_medical' '25838277-8991424304354-251119104809-complete-health.pdf' 'Airdocé¹°ç³' '%E9%BB%84%E6%B3%BD%E6%A0%A1 8991424304354' 'æŠ¥å‘Šå’¨è¯¢: 400-100-3999' '0.88'", 
    "strlen": 1140937, 
    "strlen_health": 220946, 
    "file_exist": true, 
    "file_exist_health": true
}
```

https://pe.airdoc.com/pc-v2/ytHeathyPdfPE?en_check_id=a2V5LWJqajY4ZDUzNzVjajQ4b3owdXI0Zy1qMTEzbGF0dDd0HJQ%2FlLD252wJGEObCHR0lRlddvWTUjJS9adzx6sPSJ59BHpe&language=zh_CN

# æ‰“å°çœ¼åº•æŠ¥å‘Šå®Œæ•´æŠ¥å‘Š

**é¹°ç³åŒ»ç–—è§†ç½‘è†œæ£€æŸ¥æŠ¥å‘Š**

æ£€æŸ¥å·ï¼š25838277

ä½“æ£€å·ï¼š8991424304354

```shell
{
    "0": "/data/ikang/pdf_medical/25838277-8991424304354-251119104826-simple.pdf", 
    "command": "/opt/phantomjs /opt/print.js 'https://pe.airdoc.com/pc-v2/print-ytmedical/a2V5LWJqajY4ZDUzNzVjajQ4b3owdXI0Zy1qMTEzbGF0dDd0HJQ%2FlLD252wJGEObCHR0lRlddvWTUjJS9adzx6sPSJ59BHpe?simple=true&language=zh_CN' '/data/ikang/pdf_medical' '25838277-8991424304354-251119104826-simple.pdf' 'Airdocé¹°ç³' '%E9%BB%84%E6%B3%BD%E6%A0%A1 8991424304354' 'æŠ¥å‘Šå’¨è¯¢: 400-100-3999' '0.8'", 
    "strlen": 458176, 
    "file_exist": true
}
```

https://pe.airdoc.com/pc-v2/print-ytmedical/a2V5LWJqajY4ZDUzNzVjajQ4b3owdXI0Zy1qMTEzbGF0dDd0HJQ%2FlLD252wJGEObCHR0lRlddvWTUjJS9adzx6sPSJ59BHpe?simple=true&language=zh_CN

**é£é™©è¯„ä¼°æŠ¥å‘Š**

æ£€æŸ¥å·ï¼š25838277

ä½“æ£€å·ï¼š8991424304354

```shell
{
    "0": "/data/ikang/pdf_medical/25838277-8991424304354-251119104826-simple-health.pdf", 
    "command": "/opt/phantomjs /opt/print.js 'https://pe.airdoc.com/pc-v2/ytHeathyPdfPE?en_check_id=a2V5LWJqajY4ZDUzNzVjajQ4b3owdXI0Zy1qMTEzbGF0dDd0HJQ%2FlLD252wJGEObCHR0lRlddvWTUjJS9adzx6sPSJ59BHpe&simple=true&language=zh_CN' '/data/ikang/pdf_medical' '25838277-8991424304354-251119104826-simple-health.pdf' 'Airdocé¹°ç³' '%E9%BB%84%E6%B3%BD%E6%A0%A1 8991424304354' 'æŠ¥å‘Šå’¨è¯¢: 400-100-3999' '0.88'", 
    "strlen": 458176, 
    "strlen_health": 220946, 
    "file_exist": true, 
    "file_exist_health": true
}
```

https://pe.airdoc.com/pc-v2/ytHeathyPdfPE?en_check_id=a2V5LWJqajY4ZDUzNzVjajQ4b3owdXI0Zy1qMTEzbGF0dDd0HJQ%2FlLD252wJGEObCHR0lRlddvWTUjJS9adzx6sPSJ59BHpe&simple=true&language=zh_CN

# é’‰é’‰æ¨é€é˜³æ€§è­¦ç¤ºå•

## ç¯å¢ƒå‡†å¤‡

è·å–`node`è·¯å¾„

```shell
npm config get prefix
```

æ£€æŸ¥æ˜¯å¦æœ‰`puppeteer`

```shell
npm list puppeteer
```

ä¸‹è½½`puppeteer`

```shell
npm install puppeteer
```

## jsoné…ç½®

> OSSé“¾æ¥ï¼š`oss://airdoc-ada/fundus/positive-case/`
>
> taské…ç½®ï¼š
>
> ```
> // å†…è’™å¤ç‘ä¼—
> 2 => 'dev/config_nmgrz_2.json',
> 3 => 'test/config_nmgrz_2.json',
> 4 => 'prod/config_nmgrz_2.json',
> // å®å¤ç”µä¿¡
> 5 => 'dev/config_nxdx.json',
> 6 => 'test/config_nxdx.json',
> 7 => 'prod/config_nxdx.json'
> ```

[å¼€å‘](http://ada-res.airdoc.com/fundus/positive-case/dev/config_nmgrz.json)

```json
{
  "title": "å¼€å‘dev",
  "org_ids": "40456,40540",
  "last_days": 9999,
  "next_days": 1,
  "url": "https://staging-admin.airdoc.com/admin/WarningTicketGroup",
  "node": "NODE_PATH=/Users/huangzexiao/project/node_modules /Users/huangzexiao/.nvm/versions/node/v22.14.0/bin/node",
  "webhook": "https://oapi.dingtalk.com/robot/send?access_token=7c9bd0b8efba201fce31e407dea2463d1a015ab1cbe89f75594ddf6222f95653"
}
```

[æµ‹è¯•](http://ada-res.airdoc.com/fundus/positive-case/test/config_nmgrz.json)

```json
{
  "title": "æµ‹è¯•test",
  "org_ids": "40456,40540",
  "last_days": 9999,
  "next_days": 1,
  "sn_list": "FD08DWCNW220390000S0,FD08DWCNW220390000S2,FG05DSCNW52129009102",
  "url": "https://staging-admin.airdoc.com/admin/WarningTicketGroup",
  "node": "/opt/node-v12.16.1/bin/node",
  "webhook": "https://oapi.dingtalk.com/robot/send?access_token=7c9bd0b8efba201fce31e407dea2463d1a015ab1cbe89f75594ddf6222f95653"
}
```

[ç”Ÿäº§](http://ada-res.airdoc.com/fundus/positive-case/prod/config_nmgrz.json)

```json
{
  "title": "ç‘ä¼—äººå¯¿å†…è’™å¤åˆ†å…¬å¸",
  "org_ids": "45112,47153,48247,48261",
  "last_days": 0,
  "next_days": 1,
  "sn_list": "FN12510A037AB0020PW8,FN12509A123AB0020P82,FN12509A098AA0020PP8,FN12510A027AA0020PW0,FN12509A089AA0020PP1,FN12510A034AA0020PWG,FN12509A139AA0020P8W,FN12509A072AA0020PHF,FN12509A135AA0020P8T,FN12509A055AB0020PH0,FN12509A106AA0020PPW,FN12510A045AA0020PWW,FN12509A013AB0020P54,FN12509A125AB0020P8U,FN12509A156AB0020PV2,FN12509A083AA0020PHE,FF12250A398AA00200WD,FF12250A121AA0020082,FF12317A046AA002028V,FF12307A142AA002011Z,FF12306A103AA002004M,FF12317A035AA0020280,FF12317A085AB00202VF,FF12324A185AA00203DU,FF12307A054AA00200Z8,FF12324A186AB00203D9,FF12307A376AB00201P2,FN12509A164AA0020PV8,FN12509A109AB0020PPK,FN12435A041AA0020GY5,FN12330A088AB0020UVK,FN12433A007AA0020GWW,FN12433A247AA0020GNL,FN12435A179AA0020H1A,FN12509A138AB0020P8F,FN12433A108AA0020GK6,FN12509A191AA0020PAU,FN12509A102AA0020PPT,FN12435A002AB0020G70,FN12435A147AB0020H0B,FN12509A117AA0020PP7,FN12432A037AA0020GC4,FN12325C152AB0020U10,FN12433A174AB0020GM6,FN12509A090AA0020PP2,FN12338A130AB0020URW,FN12509A054AA0020PGZ,FN12433A034AA0020GJA,FN12509A031AB0020PGP,FN12338A119AA0020URG,FN12509A149AB0020P8E,FN12509A207AA0020PA6,FN12409A030AB002053P,FN12432A017AA0020GCU,FN12432A051AA0020GF9,FN12435A194AB0020H1L,FN12432A027AB0020GCT,FN12432A009AB0020GD7,FN12433A150AB0020GR7,FN12325B035AB00203NY,FN12432A008AA0020GDE,FN12432A048AA0020GF2,FN12435A153AA0020H0J,FN12324B029AB00203CD",
  "url": "https://ikang-admin.airdoc.com/admin/WarningTicketGroup",
  "node": "/usr/bin/node",
  "webhook": "https://oapi.dingtalk.com/robot/send?access_token=f127bbdc9da41df26f10277c26a281703fea3d38fd6bb6c94ece5f03220546ef"
}
```

åˆ é™¤å†—ä½™æ–‡ä»¶ï¼š

```shell
rm -f /tmp/alarm_20250
```

## æ‰‹åŠ¨æ¨é€

å¼€å‘

```shell
NODE_PATH=/Users/huangzexiao/project/node_modules
```

```shell
php ~/project/eye-ak/public/script.php PushDingtalkPositiveAlarmMsg taskId 1
```

> å…¶ä¸­`GetPositiveCaseAlarmInfo`æ¥å£çš„é…ç½®æ˜¯èµ°çš„`dev`ç¯å¢ƒï¼Œä½†æ˜¯`PushDingtalkPositiveAlarmMsg`ä¸­ä¸‹è½½çš„pdfçš„é…ç½®æ˜¯æ¥è‡ª`test`ç¯å¢ƒçš„

æµ‹è¯•

```shell
php /var/www/test-eye/public/script.php PushDingtalkPositiveAlarmMsg taskId 1
```

ç”Ÿäº§

```shell
php /var/www/eye/public/script.php PushDingtalkPositiveAlarmMsg taskId 1
```

## å®šæ—¶ä»»åŠ¡è„šæœ¬

å¼€å‘

```shell
# v2.4
*/1 * * * *  /opt/homebrew/opt/php@7.4/bin/php ~/project/eye-ak/public/script.php PushDingtalkPositiveAlarmMsg taskId 1 >> /tmp/alarm_cron_test.log 2>&1
```

æµ‹è¯•

```shell
crontab -e
```

```shell
# v2.4
*/1 * * * * flock -xn /tmp/PushDingtalkPositiveAlarmMsg.lock -c "/usr/bin/php /var/www/test-eye/public/script.php PushDingtalkPositiveAlarmMsg taskId 1" >> /tmp/alarm_cron_test.log 2>&1

00 18 * * * flock -xn /tmp/PushDingtalkPositiveAlarmMsg.lock -c "/usr/bin/php /var/www/test-eye/public/script.php PushDingtalkPositiveAlarmMsg taskId 1" >> /tmp/alarm_cron_daily.log 2>&1

# å†…è’™å¤ç‘ä¼—é˜³æ€§è­¦ç¤ºå•æ¨é€
00 18 * * * flock -xn /tmp/PushDingtalkPositiveAlarmMsg_taskId-3.lock -c "/usr/bin/php /var/www/eye/public/script.php PushDingtalkPositiveAlarmMsg taskId 3" >> /tmp/alarm_cron_daily_taskId-3.log 2>&1
# å®å¤ç”µä¿¡é˜³æ€§è­¦ç¤ºå•æ¨é€
00 18 * * * flock -xn /tmp/PushDingtalkPositiveAlarmMsg_taskId-6.lock -c "/usr/bin/php /var/www/eye/public/script.php PushDingtalkPositiveAlarmMsg taskId 6" >> /tmp/alarm_cron_daily_taskId-6.log 2>&1
```

ç”Ÿäº§

```shell
crontab -e -l hailong
```

```shell
# v2.1
#*/1 * * * * flock -xn /tmp/PushDingtalkPositiveAlarmMsg.lock -c '/usr/bin/php /var/www/eye/public/script.php PushDingtalkPositiveAlarmMsg' >> /tmp/alarm_cron_test.log 2>&1
00 18 * * * flock -xn /tmp/PushDingtalkPositiveAlarmMsg.lock -c '/usr/bin/php /var/www/eye/public/script.php PushDingtalkPositiveAlarmMsg' >> /tmp/alarm_cron_daily.log 2>&1

# v2.4
*/1 * * * * flock -xn /tmp/PushDingtalkPositiveAlarmMsg.lock -c "/usr/bin/php /var/www/eye/public/script.php PushDingtalkPositiveAlarmMsg taskId 1" >> /tmp/alarm_cron_test.log 2>&1
00 18 * * * flock -xn /tmp/PushDingtalkPositiveAlarmMsg.lock -c "/usr/bin/php /var/www/eye/public/script.php PushDingtalkPositiveAlarmMsg taskId 1" >> /tmp/alarm_cron_daily.log 2>&1

# å†…è’™å¤ç‘ä¼—é˜³æ€§è­¦ç¤ºå•æ¨é€
#00 18 * * * flock -xn /tmp/PushDingtalkPositiveAlarmMsg_taskId-4.lock -c "/usr/bin/php /var/www/eye/public/script.php PushDingtalkPositiveAlarmMsg taskId 4" >> /tmp/alarm_cron_daily_taskId-4.log 2>&1

# å®å¤ç”µä¿¡é˜³æ€§è­¦ç¤ºå•æ¨é€
00 18 * * * flock -xn /tmp/PushDingtalkPositiveAlarmMsg_taskId-7.lock -c "/usr/bin/php /var/www/eye/public/script.php PushDingtalkPositiveAlarmMsg taskId 7" >> /tmp/alarm_cron_daily_taskId-7.log 2>&1
```

## ä¸‹è½½pdfå‘½ä»¤

æ ¹æ®`test`ç¯å¢ƒçš„é…ç½®ï¼Œä¸‹è½½å†å²ä¸Šæ‰€æœ‰çš„é˜³æ€§è­¦ç¤ºå•

> å¯é€‰taskId=2ã€3ã€5ã€6

```shell
node ~/project/eye-ak/misc/pdf_generator/print-v3.js \
  --url "https://staging-admin.airdoc.com/admin/WarningTicketGroup?taskId=2" \
  --path "/tmp/alarm_$(date +%Y%m%d)" \
  --fileName "alarm_$(date +%Y%m%d_%H%M%S).pdf" \
  --zoom 0.9
```

æ ¹æ®`prod`ç¯å¢ƒçš„é…ç½®ï¼Œä¸‹è½½å½“å¤©çš„é˜³æ€§è­¦ç¤ºå•

> å¯é€‰taskId=4ã€7

```shell
node ~/project/eye-ak/misc/pdf_generator/print-v3.js \
  --url "https://ikang-admin.airdoc.com/admin/WarningTicketGroup?taskId=4" \
  --path "/tmp/alarm_$(date +%Y%m%d)" \
  --fileName "alarm_$(date +%Y%m%d_%H%M%S).pdf" \
  --zoom 0.9
```

## åç»­ä¼˜åŒ–

`PushDingtalkPositiveAlarmMsg`é»˜è®¤è¯»å–çš„æ˜¯`dev`ä¸­çš„é…ç½®ï¼Œè¿™ä¸å¯¹

`GetPositiveCaseAlarmInfo`è¿˜æ˜¯æŒ‰åŸŸåè¯»çš„ï¼Œåº”è¯¥æŒ‰envå‚æ•°è¯»

# æ¨é€å›½å†…å’Œæµ·å¤–è­¦ç¤ºå•å›¾ç‰‡

æœ¬åœ°æ‰“å°æµ‹è¯•ï¼š

```shell
node /Users/hzx/project/print-reactive-cookie-image.js \
  "https://staging-admin.airdoc.com/admin/WarningTicket?status=1&checkId=3431373&language=en" \
  "/tmp/alarm" \
  "alarm_test_333.png" \
  "" \
  "fantastic" \
  "783569961320c56167147ffc892bd0f7" \
```

æœ¬åœ°æ‰“å°çº¿ä¸Šï¼š

```shell
node /Users/hzx/project/print-reactive-cookie-image.js \
  "https://ikang-admin.airdoc.com/admin/WarningTicket?checkId=22624037&status=1" \
  "/Users/hzx/Downloads" \
  "alarm_1.pdf" \
  "" \
  "fantastic" \
  "bb80072549c768d974d14e1ee31f5b42"
```

çº¿ä¸Šæ‰“å°ï¼š

```shell
/opt/phantomjs /opt/print-alarm-report.js \
  'https://staging-admin.airdoc.com/admin/WarningTicket?status=1&checkId=3446836&language=en' \
  '/var/log/airlog/alarm_autopush_print/202511/07' \
  'alarm_3446836_251107214600.png' \
  '' \
  'fantastic' \
  'bb80072549c768d974d14e1ee31f5b42'
```

# æ— cookieä¸‹è½½pdf

æ‰“å°HRVæŠ¥å‘Š

```shell
node ~/project/eye-ak/misc/pdf_generator/print-v3.js \
  --url "https://mpd.babyeye.com/hrvreport?language=zh_CN&reportId=1982955593823948802" \
  --path "/Users/hzx/Downloads/alarm_$(date +%Y%m%d)" \
  --fileName "alarm_$(date +%Y%m%d_%H%M%S).pdf" \
  --zoom 0.9
```

æœ¬åœ°è¿è¡Œå‘½ä»¤ï¼š

åŒ—å¸ˆå¤§ç‰ˆ

```shell
node ~/project/print-realstyle-nocookie-pdf.js \
  --url 'https://test-neuro-ai.airdoc.com/hrvreport?language=zh-CN&reportId=1996474764382801921' \
  --path '/Users/hzx/Downloads' \
  --fileName '{$filename}' \
  --zoom '0.9'
```

V2ç‰ˆï¼š

```shell
node ~/project/print-realstyle-nocookie-pdf.js \
  --url 'https://neuro-ai.airdoc.com/hrvreport?language=zh-CN&reportId=2004000887084683265' \
  --path '/Users/hzx/Downloads' \
  --fileName '{$filename}' \
  --zoom '0.9'
```

**Linux æœºå™¨ä¸Šçš„è¿è¡Œæƒ…å†µ**

1. **å¦‚æœ Linux æœºå™¨å·²å®‰è£… Puppeteer å’Œ Chrome/Chromiumï¼š**

   - âœ… è„šæœ¬å¯ä»¥æ­£å¸¸è¿è¡Œã€‚
   - è„šæœ¬èƒ½è‡ªåŠ¨æ£€æµ‹å¸¸è§çš„ Chrome/Chromium å®‰è£…è·¯å¾„ã€‚
   - æ”¯æŒçš„å…¸å‹è·¯å¾„åŒ…æ‹¬ï¼š
     - `/usr/bin/google-chrome`
     - `/usr/bin/chromium-browser`
     - `/snap/bin/chromium`
     - ä»¥åŠå…¶ä»–æ ‡å‡†ç³»ç»Ÿè·¯å¾„ã€‚

2. **Linux ç¯å¢ƒå‡†å¤‡æ­¥éª¤ï¼š**

   **å®‰è£… Google Chromeï¼ˆé€‚ç”¨äº Ubuntu/Debianï¼‰ï¼š**

   ```bash
   sudo apt-get update
   sudo apt-get install -y google-chrome-stable
   ```

   **æˆ–å®‰è£… Chromiumï¼š**

   ```bash
   sudo apt-get install -y chromium-browser
   ```

   **å®‰è£… Node.js å’Œ Puppeteerï¼š**

   ```bash
   npm install puppeteer
   ```

3. **è„šæœ¬ç‰¹æ€§ï¼š**

   - ğŸ”„ **è·¨å¹³å°æ”¯æŒ**ï¼šè‡ªåŠ¨è¯†åˆ«è¿è¡Œç¯å¢ƒï¼ˆLinuxã€macOSã€Windowsï¼‰ã€‚
   - ğŸ” **æ™ºèƒ½æµè§ˆå™¨è·¯å¾„æ¢æµ‹**ï¼šæŒ‰ä¼˜å…ˆçº§å°è¯•å¤šä¸ªå¸¸è§ Chrome/Chromium å®‰è£…ä½ç½®ã€‚
   - ğŸ¯ **è‡ªåŠ¨é™çº§æœºåˆ¶**ï¼šè‹¥æœªæ‰¾åˆ°ç³»ç»Ÿä¸­å·²å®‰è£…çš„ Chromeï¼Œä¼šå›é€€ä½¿ç”¨ Puppeteer è‡ªå¸¦çš„ Chromiumã€‚
   - ğŸ“ **è¯¦ç»†æ—¥å¿—è¾“å‡º**ï¼šè¿è¡Œæ—¶ä¼šæ‰“å°å®é™…ä½¿ç”¨çš„æµè§ˆå™¨å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ï¼Œä¾¿äºè°ƒè¯•ã€‚

4. **Linux ä¸“ç”¨ä¼˜åŒ–ï¼š**

   - ä¿ç•™äº† `--no-sandbox` å‚æ•°ï¼ˆåœ¨é root ç”¨æˆ·æˆ–å®¹å™¨ç¯å¢ƒä¸­é€šå¸¸å¿…éœ€ï¼‰ã€‚
   - ä¿ç•™äº† `--disable-dev-shm-usage` å‚æ•°ï¼ˆé˜²æ­¢å›  `/dev/shm` å†…å­˜ä¸è¶³å¯¼è‡´å´©æºƒï¼Œå°¤å…¶åœ¨ Docker ä¸­å¸¸è§ï¼‰ã€‚

# å¸¦cookieä¸‹è½½pdfï¼ˆåŸæ±åŸå‘³çš„ç½‘é¡µï¼‰

```shell
# é»˜è®¤PCç‰ˆï¼Œç¼©æ”¾1.00
node ~/project/print-realstyle-cookie-pdf.js \
  "https://ikang-admin.airdoc.com/admin/WarningTicket?checkId=25710228&status=1" \
  "/tmp" \
  "25710228.pdf" \
  "bb80072549c768d974d14e1ee31f5b42" \
  "ikang-admin.airdoc.com"

# æŒ‡å®šPCç‰ˆï¼Œç¼©æ”¾0.8
node ~/project/print-realstyle-cookie-pdf.js \
  "https://ikang-admin.airdoc.com/admin/WarningTicket?checkId=25710228&status=1" \
  "/tmp" \
  "25710228.pdf" \
  "bb80072549c768d974d14e1ee31f5b42" \
  "ikang-admin.airdoc.com" \
  "pc" \
  "0.7"

# æŒ‡å®šç§»åŠ¨ç‰ˆï¼Œç¼©æ”¾1.00
node ~/project/print-realstyle-cookie-pdf.js \
  "https://ikang-admin.airdoc.com/admin/WarningTicket?checkId=25710228&status=1" \
  "/tmp" \
  "25710228.pdf" \
  "bb80072549c768d974d14e1ee31f5b42" \
  "ikang-admin.airdoc.com" \
  "mobile"
```

# å¸¦cookieæ‰“å°pdf

æ‰“å°çœ¼åº•è­¦ç¤ºå•

```shell
node /Users/hzx/project/print-style-cookie-pdf.js \
  --url "https://ikang-admin.airdoc.com/admin/WarningTicket?checkId=25710228&status=1" \
  --fold "/Users/hzx/Downloads" \
  --file "25710228.pdf" \
  --cookie "bb80072549c768d974d14e1ee31f5b42" \
  --zoom "0.70"
```

æ‰“å°æŠ—å‹æŠ¥å‘Š

```shell
node /Users/hzx/project/print-style-cookie-pdf.js \
  --url "https://neuro-ai.airdoc.com/hrvreport?language=zh-CN&reportId=2004000887084683265" \
  --fold "/Users/hzx/Downloads" \
  --file "123.pdf" \
  --cookie "bb80072549c768d974d14e1ee31f5b42" \
  --zoom "0.95"
```

```shell
node /Users/hzx/project/print-style-cookie-pdf.js \
  --url "https://neuro-ai.airdoc.com/hrvreport?language=zh-CN&reportId=2004000887084683265" \
  --fold "/Users/hzx/Downloads"
```

# éƒ¨ç½²PDFç”ŸæˆDockeræœåŠ¡

**åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨**

```shell
docker stop print-service && docker rm print-service
```

æ„å»ºé•œåƒ

```shell
docker build --platform linux/arm64 -t print-service .
```

```
docker build --platform linux/amd64 -t print-service .
```

å¯åŠ¨å®¹å™¨

```shell
docker run -d -p 3050:3050 --name print-service print-service
```

```shell
docker run -d -p 3050:3050 -v /tmp/report:/tmp/report --name print-service print-service
```

æµ‹è¯•ç½‘ç»œè¿æ¥

```shell
docker exec -it print-service bash
```

```shell
curl -I https://www.baidu.com
```

```shell
curl -I https://neuro-ai.airdoc.com
```

# æŠ—å‹mpd_analyseç®—æ³•æœåŠ¡

æ‰“åŒ…ã€ä¸Šä¼ 

```shell
docker build -t mpd_analyse:2.11-amd64 .
```

```shell
./build.sh amd64 2.11-amd64
```

```shell
docker save -o mpd_analyse.tar mpd_analyse:2.11-amd64
```

```shell
./build.sh amd64 2.11-amd64 save
```

åŠ è½½é•œåƒ

```shell
curl -o mpd_analyse.tar https://airdoc-ada.oss-cn-beijing.aliyuncs.com/tmp/mpd_analyse_amd64_2.11-amd64.tar
```

```shell
docker load -i mpd_analyse.tar
```

æœåŠ¡å™¨åœæ­¢æ—§é•œåƒï¼Œå¹¶åŠ è½½ã€è¿è¡Œæ–°é•œåƒ

```shell
docker stop mpd_analyse && docker rm mpd_analyse
```

```shell
docker run -d -p 0.0.0.0:8722:8722 -v /data/logs/mpd_analyse:/data/logs/mpd_analyse --name mpd_analyse mpd_analyse:2.11-amd64
```

~~*ä½¿ç”¨ Docker Hub*~~

```shell
docker tag mpd_analyse:latest your-username/mpd_analyse:latest
```

```shell
docker push your-username/mpd_analyse:latest
```

~~*ä½¿ç”¨ç§æœ‰ä»“åº“*~~

```shell
docker tag mpd_analyse:latest registry.example.com/mpd_analyse:latest
```

```shell
docker push registry.example.com/mpd_analyse:latest
```

# æŠ—å‹pdf-serviceæ‰“å°PDFæœåŠ¡

æ‰“åŒ…ã€ä¸Šä¼ 

```shell
./build.sh amd64 1.1-amd64 save
```

æœåŠ¡å™¨åœæ­¢æ—§é•œåƒï¼Œå¹¶åŠ è½½ã€è¿è¡Œæ–°é•œåƒ

```shell
docker stop print-service && docker rm print-service
```

```shell
curl -o print-service.tar https://airdoc-ada.oss-cn-beijing.aliyuncs.com/tmp/print-service_amd64_1.1-amd64.tar
```

```shell
docker load -i print-service.tar
```

```shell
docker run -d -p 0.0.0.0:3050:3050 -v /tmp/report:/tmp/report --name print-service print-service:1.1-amd64
```

























---

# å…¶ä»–

## å·²å®Œæˆçš„é‡æ„å†…å®¹

### 1. **æ ¸å¿ƒæ¶æ„ç»„ä»¶**

- **`TaskTypeEnum`** - ä»»åŠ¡ç±»å‹æšä¸¾ï¼Œæ”¯æŒå¤šç§ä»»åŠ¡ç±»å‹ï¼ˆASSESSMENT, PDF_GENERATE, PUSH_REPORT, ASSESSMENT_FLOWï¼‰
- **`AsyncTask`** - å¼‚æ­¥ä»»åŠ¡æŠ½è±¡åŸºç±»ï¼ŒåŒ…å« `traceId`ï¼ˆè¿½è¸ªIDï¼‰å’Œ `businessId`ï¼ˆä¸šåŠ¡å¯¹è±¡IDï¼‰
- **`AbstractRedissonBlockingQueueConsumer`** - æŠ½è±¡æ¶ˆè´¹è€…åŸºç±»ï¼Œæä¾›ç»Ÿä¸€æ¶ˆè´¹æ¡†æ¶

### 2. **é‡æ„çš„ç°æœ‰ç»„ä»¶**

- **`AssessmentTask`** - ç»§æ‰¿ `AsyncTask`ï¼Œå®ç° `taskType()` æ–¹æ³•ï¼Œè‡ªåŠ¨åŒæ­¥ `businessId` å’Œ `assessmentId`
- **`AssessmentTaskConsumer`** - ç»§æ‰¿æŠ½è±¡åŸºç±»ï¼Œä¿æŒå‘åå…¼å®¹ï¼ŒåŒæ—¶æ”¯æŒå»¶è¿Ÿé˜Ÿåˆ—
- **`TaskProducer`** - ç»Ÿä¸€ä»»åŠ¡æŠ•é€’å™¨ï¼Œæ ¹æ®ä»»åŠ¡ç±»å‹è‡ªåŠ¨è·¯ç”±åˆ°å¯¹åº”é˜Ÿåˆ—

### 3. **ä¿æŒå‘åå…¼å®¹**

- **`AssessmentTaskProducer`** - ä¿ç•™ä¸º `@Deprecated`ï¼Œç°æœ‰ä»£ç å¯ç»§ç»­ä½¿ç”¨
- é˜Ÿåˆ—åç§°ä¿æŒä¸å˜ï¼ˆ`assessmentTaskQueue`ï¼‰ï¼Œç¡®ä¿ç°æœ‰ä»»åŠ¡æ­£å¸¸æ¶ˆè´¹
- å»¶è¿Ÿé˜Ÿåˆ—æœºåˆ¶ä¿æŒåŸæœ‰å®ç°

### 4. **æ‰©å±•èƒ½åŠ›**

æ¶æ„å·²æ”¯æŒä»¥ä¸‹æ‰©å±•ï¼š

1. æ–°å¢ä»»åŠ¡ç±»å‹ï¼šåœ¨ `TaskTypeEnum` ä¸­æ·»åŠ æ–°ç±»å‹
2. åˆ›å»ºæ–°ä»»åŠ¡ç±»ï¼šç»§æ‰¿ `AsyncTask` å¹¶å®ç° `taskType()`
3. åˆ›å»ºæ–°æ¶ˆè´¹è€…ï¼šç»§æ‰¿ `AbstractRedissonBlockingQueueConsumer`
4. åˆ›å»ºæ–°å¤„ç†å™¨ï¼šå®ç°ä¸šåŠ¡é€»è¾‘å¤„ç†

## ä½¿ç”¨ç¤ºä¾‹

### å‘é€è¯„ä¼°ä»»åŠ¡ï¼ˆä½¿ç”¨æ–°æ–¹å¼ï¼‰
```java
AssessmentTask task = AssessmentTask.builder()
    .assessmentId(reportId)
    .needAnalyze(true)
    .needPush(true)
    .build();
taskProducer.send(task); // ä½¿ç”¨æ–°çš„ç»Ÿä¸€ç”Ÿäº§è€…
```

### æœªæ¥æ‰©å±•ç¤ºä¾‹ï¼šåˆ›å»ºPDFç”Ÿæˆä»»åŠ¡
```java
// 1. åœ¨TaskTypeEnumä¸­æ·»åŠ PDF_GENERATEï¼ˆå·²å®Œæˆï¼‰

// 2. åˆ›å»ºPdfGenerateTask
public class PdfGenerateTask extends AsyncTask {
    private Long reportId;
    
    @Override
    public TaskTypeEnum taskType() {
        return TaskTypeEnum.PDF_GENERATE;
    }
}

// 3. åˆ›å»ºPdfGenerateTaskConsumer
@Component
public class PdfGenerateTaskConsumer extends AbstractRedissonBlockingQueueConsumer<PdfGenerateTask> {
    @Override
    protected String queueKey() {
        return BizConstants.PDF_GENERATE_TASK_QUEUE_KEY;
    }
    // ... å®ç°handleæ–¹æ³•
}

// 4. å‘é€ä»»åŠ¡
PdfGenerateTask task = new PdfGenerateTask(reportId);
taskProducer.send(task);
```

## æ¶æ„ç‰¹ç‚¹

1. ç±»å‹å®‰å…¨ï¼šé€šè¿‡æšä¸¾å’Œæ³›å‹ç¡®ä¿ç±»å‹å®‰å…¨
2. æ˜“äºæ‰©å±•ï¼šæ–°å¢ä»»åŠ¡ç±»å‹åªéœ€å®ç°å¯¹åº”æ¥å£
3. çŠ¶æ€ç®¡ç†ï¼šé€šè¿‡ `businessId` è¿½è¸ªä¸šåŠ¡å¯¹è±¡çŠ¶æ€
4. è¿½è¸ªèƒ½åŠ›ï¼šæ¯ä¸ªä»»åŠ¡æœ‰å”¯ä¸€ `traceId` ç”¨äºæ—¥å¿—è¿½è¸ª
5. å‘åå…¼å®¹ï¼šç°æœ‰åŠŸèƒ½ä¸å—å½±å“

æ¶æ„å·²æ”¯æŒæœªæ¥çš„æ‰©å±•éœ€æ±‚ï¼Œå¦‚ pipeline æµç¨‹ã€"ç”ŸæˆPDF"ã€"æ¨é€ç¬¬ä¸‰æ–¹æ¥å£" ç­‰ä»»åŠ¡ç±»å‹ã€‚
