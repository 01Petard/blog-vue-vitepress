æœ¬æ–‡å°†è¯¦ç»†è®²è®²å¾®ä¿¡å°ç¨‹åºçš„æ³¨å†Œç™»å½• + å¾®ä¿¡æ”¯ä»˜çš„å‰åç«¯å®Œæ•´æµç¨‹ï¼Œæ¶µç›–æ‰€æœ‰å‚æ•°ä¼ é€’å’Œé…åˆç»†èŠ‚ï¼ŒæŒ‰æ¨¡å—ä¸€æ­¥æ­¥æ‹†è§£ï¼Œéå¸¸é€‚åˆ Java + Spring Boot é¡¹ç›®å¼€å‘è€…é£Ÿç”¨ã€‚

## ğŸ“Œ ä¸€ã€å¾®ä¿¡å°ç¨‹åºæ³¨å†Œç™»å½• â€” å‰åç«¯åä½œè¯¦è§£

### ğŸ“² å‰ç«¯ï¼ˆå°ç¨‹åºç«¯ï¼‰

#### 1. ä½¿ç”¨ `wx.login()` è·å–ä¸´æ—¶ç™»å½•å‡­è¯ï¼ˆcodeï¼‰ï¼š

```js
wx.login({
  success(res) {
    const code = res.code;
    wx.request({
      url: 'https://ä½ çš„åç«¯åœ°å€/api/wx/login',
      method: 'POST',
      data: { code },
      success: (resp) => {
        const token = resp.data.token;
        wx.setStorageSync('token', token); // å­˜å…¥æœ¬åœ°
      }
    });
  }
});
```

### ğŸ’» åç«¯ï¼ˆSpring Bootï¼‰

#### 1. æ§åˆ¶å™¨æ¥å£

```java
@PostMapping("/api/wx/login")
public R<LoginVO> wxLogin(@RequestBody WxLoginDTO dto) {
    String code = dto.getCode();

    // é€šè¿‡ code è·å– session_key + openid
    String url = "https://api.weixin.qq.com/sns/jscode2session" +
                 "?appid=" + appId +
                 "&secret=" + appSecret +
                 "&js_code=" + code +
                 "&grant_type=authorization_code";

    String resStr = restTemplate.getForObject(url, String.class);
    JSONObject resJson = JSON.parseObject(resStr);

    String openId = resJson.getString("openid");
    String sessionKey = resJson.getString("session_key");

    // ç»‘å®š openId åˆ°ç”¨æˆ·ï¼ˆå¦‚ä¸å­˜åœ¨åˆ™æ³¨å†Œï¼‰
    User user = userService.getOrCreateByOpenId(openId);

    // ç”Ÿæˆ JWT
    String token = jwtUtils.generateToken(user.getId());

    return R.ok(new LoginVO(token));
}
```

#### 2. DTO / VO ç¤ºä¾‹ï¼š

```java
@Data
public class WxLoginDTO {
    private String code;
}

@Data
@AllArgsConstructor
public class LoginVO {
    private String token;
}
```

#### 3. JWT å·¥å…·ç±» generateToken()

```java
public String generateToken(Long userId) {
    return Jwts.builder()
        .setSubject(String.valueOf(userId))
        .setIssuedAt(new Date())
        .setExpiration(new Date(System.currentTimeMillis() + 86400000))
        .signWith(SignatureAlgorithm.HS256, secretKey)
        .compact();
}
```

## ğŸ’° äºŒã€å¾®ä¿¡å°ç¨‹åºæ”¯ä»˜ â€” å‰åç«¯å®Œæ•´æµç¨‹

### ğŸ§  åœºæ™¯è¯´æ˜

* å‰ç«¯å‘èµ·æ”¯ä»˜è¯·æ±‚ï¼ˆéœ€è¦æºå¸¦è®¢å•å·ï¼‰
* åç«¯ç”Ÿæˆ prepay\_idï¼Œæ„é€ æ”¯ä»˜å‚æ•°
* å‰ç«¯ç”¨ `wx.requestPayment()` å‘èµ·æ”¯ä»˜
* æ”¯ä»˜å®Œæˆï¼Œå¾®ä¿¡å›è°ƒ notify\_url

### ğŸ“² å‰ç«¯æµç¨‹

```js
// è·å–åå°æ”¯ä»˜å‚æ•°
wx.request({
  url: 'https://ä½ çš„åç«¯åœ°å€/api/pay/wx',
  method: 'POST',
  header: {
    Authorization: 'Bearer ' + wx.getStorageSync('token')
  },
  data: { orderId: 'ORDER_123456' },
  success: (res) => {
    const payInfo = res.data;
    wx.requestPayment({
      ...payInfo,
      success() {
        console.log('æ”¯ä»˜æˆåŠŸ');
      },
      fail() {
        console.log('æ”¯ä»˜å¤±è´¥');
      }
    });
  }
});
```

### ğŸ’» åç«¯æµç¨‹

#### 1. æ¥æ”¶æ”¯ä»˜è¯·æ±‚ & è°ƒç”¨å¾®ä¿¡ç»Ÿä¸€ä¸‹å• API

```java
@PostMapping("/api/pay/wx")
public R<Map<String, String>> unifiedOrder(@RequestBody WxPayDTO dto, HttpServletRequest request) {
    Order order = orderService.getById(dto.getOrderId());
    if (order == null || order.getStatus() != OrderStatus.UNPAID) {
        return R.fail("è®¢å•ä¸å­˜åœ¨æˆ–å·²æ”¯ä»˜");
    }

    WxPayUnifiedOrderRequest payRequest = new WxPayUnifiedOrderRequest();
    payRequest.setOutTradeNo(order.getOrderNo());
    payRequest.setTotalFee(order.getPayAmount().multiply(new BigDecimal(100)).intValue()); // å•ä½ï¼šåˆ†
    payRequest.setBody("è®¢å•æ”¯ä»˜");
    payRequest.setOpenid(getOpenIdFromToken());
    payRequest.setTradeType("JSAPI");
    payRequest.setNotifyUrl("https://ä½ çš„åç«¯åœ°å€/api/pay/notify");

    WxPayUnifiedOrderResult result = wxPayService.unifiedOrder(payRequest);

    // äºŒæ¬¡ç­¾åå‚æ•°
    Map<String, String> payParam = new HashMap<>();
    payParam.put("appId", appId);
    payParam.put("timeStamp", String.valueOf(System.currentTimeMillis() / 1000));
    payParam.put("nonceStr", RandomUtil.randomString(32));
    payParam.put("package", "prepay_id=" + result.getPrepayId());
    payParam.put("signType", "MD5");

    // ç­¾å
    String paySign = WxPayUtil.createSign(payParam, "UTF-8", mchKey);
    payParam.put("paySign", paySign);

    return R.ok(payParam);
}
```

#### 2. æ”¯ä»˜å›è°ƒï¼ˆå¾®ä¿¡æœåŠ¡å™¨è°ƒç”¨ï¼‰

```java
@PostMapping("/api/pay/notify")
public String wxNotify(HttpServletRequest request) throws Exception {
    String xml = IOUtils.toString(request.getInputStream(), StandardCharsets.UTF_8);
    WxPayOrderNotifyResult notifyResult = wxPayService.parseOrderNotifyResult(xml);

    String outTradeNo = notifyResult.getOutTradeNo();
    if ("SUCCESS".equals(notifyResult.getResultCode())) {
        orderService.markPaid(outTradeNo);
    }
    return "<xml><return_code>SUCCESS</return_code></xml>";
}
```

### ğŸš€ æ•°æ®æµå‘æ€»ç»“å›¾ï¼š

```text
å°ç¨‹åº(wx.login) â†’ åç«¯(codeæ¢openId) â†’ ç”ŸæˆJWT â†’ å°ç¨‹åºå­˜token

å°ç¨‹åº(è¯·æ±‚æ”¯ä»˜) â†’ åç«¯(unifiedOrder) â†’ ç”ŸæˆprepayId â†’ äºŒæ¬¡ç­¾åè¿”å›å‚æ•°

å°ç¨‹åº(wx.requestPayment) â†’ å¾®ä¿¡æ”¯ä»˜ç³»ç»Ÿ â†’ å›è°ƒåç«¯ /api/pay/notify â†’ ä¿®æ”¹è®¢å•çŠ¶æ€
```

---

## âœ… è¡¥å……å»ºè®®

| æ¨¡å—     | è¦ç‚¹                              |
| -------- | --------------------------------- |
| ç™»å½•     | ç”¨ openId ç»‘å®šç”¨æˆ·                |
| token    | å»ºè®®ç”¨ JWTï¼Œé¿å… session å­˜å‚¨     |
| å¾®ä¿¡æ”¯ä»˜ | å¿…é¡»å¤‡æ¡ˆå•†æˆ· + é…ç½® v3 key + è¯ä¹¦ |
| å®‰å…¨     | æ‰€æœ‰æ¥å£åŠ  token æ ¡éªŒ + å‚æ•°æ ¡éªŒ  |
| å›è°ƒ     | å¹‚ç­‰å¤„ç†ï¼Œè®¢å•çŠ¶æ€ä¸å¯é‡å¤å˜æ›´    |

---



# å¾®ä¿¡ç™»å½•/æ³¨å†Œã€ä»˜æ¬¾ã€é€€æ¬¾æ ¸å¿ƒåŠŸèƒ½æœ€ä½³å®è·µï¼Œåç«¯åŠŸèƒ½demo
å¥½çš„ï¼Œå’±ä»¬ç›´æ¥æ¥ä¸€å¥—å®Œæ•´çš„ã€**å¯è½åœ°çš„å¾®ä¿¡å°ç¨‹åºæ ¸å¿ƒåŠŸèƒ½åç«¯å®è·µä»£ç **ï¼šåŒ…å«**ç™»å½•/æ³¨å†Œ**ã€**ä»˜æ¬¾** å’Œ **é€€æ¬¾**ã€‚ç”¨çš„æ˜¯ Java + Spring Bootï¼Œç»“æ„æ¸…æ™°ã€å®é™…å¯è·‘ï¼Œé€‚åˆä½ ä½œä¸ºåç«¯å¼€å‘ç›´æ¥é›†æˆå’Œè°ƒè¯•ã€‚

## ğŸ§© æŠ€æœ¯æ ˆå‡è®¾

* Spring Boot 3.x
* ä½¿ç”¨ RestTemplate / HttpClient è¯·æ±‚å¾®ä¿¡æœåŠ¡å™¨
* æ•°æ®åº“ï¼šMySQLï¼ˆä¿å­˜ç”¨æˆ·ã€è®¢å•ç­‰ï¼‰
* å·²è·å–ï¼šå¾®ä¿¡å°ç¨‹åº `appId` å’Œ `secret`
* å·²é…ç½®ï¼šå¾®ä¿¡å•†æˆ·å¹³å°çš„ `mchid`ã€`apiV3Key`ã€`å•†æˆ·è¯ä¹¦`

## ğŸ“Œ é¡¹ç›®ç»“æ„ç®€è¿°

```
com.xxx.wechat
â”œâ”€â”€ controller
â”‚   â””â”€â”€ WxController.java       // æ§åˆ¶å™¨
â”œâ”€â”€ service
â”‚   â”œâ”€â”€ WxAuthService.java      // ç™»å½•é€»è¾‘
â”‚   â”œâ”€â”€ WxPayService.java       // æ”¯ä»˜é€»è¾‘
â”œâ”€â”€ util
â”‚   â””â”€â”€ WxPayUtils.java         // ç­¾åå·¥å…·
â”œâ”€â”€ dto
â”‚   â”œâ”€â”€ LoginRequest.java
â”‚   â””â”€â”€ PayRequest.java
â”œâ”€â”€ entity
â”‚   â””â”€â”€ User.java
â””â”€â”€ config
    â””â”€â”€ WxPayConfig.java        // å¾®ä¿¡é…ç½®
```

## âœ… ç™»å½•ä¸æ³¨å†Œå®ç°ï¼ˆwx.loginï¼‰

### å‰ç«¯å°ç¨‹åº

```js
// login.js
wx.login({
  success: res => {
    wx.request({
      url: 'http://localhost:8080/wx/login',
      method: 'POST',
      data: {
        code: res.code
      },
      success: r => {
        console.log('ç™»å½•æˆåŠŸ', r.data)
        wx.setStorageSync('token', r.data.token)
      }
    })
  }
})
```

### åç«¯ Controller

```java
@PostMapping("/wx/login")
public ApiResponse<?> login(@RequestBody LoginRequest request) {
    return ApiResponse.success(wxAuthService.loginOrRegister(request.getCode()));
}
```

### Serviceï¼šå¾®ä¿¡ç™»å½•å®ç°

```java
@Service
public class WxAuthService {

    @Value("${wx.appid}")
    private String appId;

    @Value("${wx.secret}")
    private String secret;

    @Autowired
    private UserRepository userRepository;

    public LoginResponse loginOrRegister(String code) {
        String url = "https://api.weixin.qq.com/sns/jscode2session?appid=" + appId +
                "&secret=" + secret + "&js_code=" + code + "&grant_type=authorization_code";

        String response = HttpUtil.get(url); // Hutool å¯æ›¿æ¢ä¸ºå…¶ä»– Http å·¥å…·
        JSONObject json = JSONUtil.parseObj(response);

        String openid = json.getStr("openid");
        String sessionKey = json.getStr("session_key");

        User user = userRepository.findByOpenid(openid)
                .orElseGet(() -> {
                    User newUser = new User();
                    newUser.setOpenid(openid);
                    newUser.setCreateTime(LocalDateTime.now());
                    return userRepository.save(newUser);
                });

        String token = JwtUtils.generateToken(user.getId()); // è‡ªè¡Œå°è£… JWT å·¥å…·ç±»
        return new LoginResponse(token, user.getId(), openid);
    }
}
```

## ğŸ’° å‘èµ·å¾®ä¿¡æ”¯ä»˜ï¼ˆJSAPIï¼‰

### å‰ç«¯æ”¯ä»˜æµç¨‹ï¼ˆå¾®ä¿¡å°ç¨‹åºï¼‰

```js
// pay.js
wx.request({
  url: 'http://localhost:8080/wx/pay',
  method: 'POST',
  data: {
    orderNo: 'ORDER12345',
    amount: 100   // å•ä½ï¼šåˆ†
  },
  success: res => {
    const payData = res.data.data;
    wx.requestPayment({
      ...payData,
      success(res) {
        console.log('æ”¯ä»˜æˆåŠŸ', res)
      },
      fail(err) {
        console.log('æ”¯ä»˜å¤±è´¥', err)
      }
    })
  }
})
```

### åç«¯æ”¯ä»˜æ¥å£

```java
@PostMapping("/wx/pay")
public ApiResponse<?> pay(@RequestBody PayRequest req) {
    return ApiResponse.success(wxPayService.createOrder(req));
}
```

### å¾®ä¿¡æ”¯ä»˜æ ¸å¿ƒé€»è¾‘ï¼ˆV3 JSAPIï¼‰

```java
@Service
public class WxPayService {

    @Autowired
    private WxPayConfig config;

    public Map<String, String> createOrder(PayRequest req) {
        String url = "https://api.mch.weixin.qq.com/v3/pay/transactions/jsapi";

        Map<String, Object> body = new HashMap<>();
        body.put("appid", config.getAppId());
        body.put("mchid", config.getMchId());
        body.put("description", "è®¢å•æ”¯ä»˜");
        body.put("out_trade_no", req.getOrderNo());
        body.put("notify_url", config.getNotifyUrl());

        Map<String, Object> amount = new HashMap<>();
        amount.put("total", req.getAmount());
        body.put("amount", amount);

        Map<String, String> payer = new HashMap<>();
        payer.put("openid", getOpenIdFromToken()); // ä» JWT token ä¸­è§£æç”¨æˆ·ä¿¡æ¯
        body.put("payer", payer);

        String result = WxPayUtils.v3Post(url, body, config);
        JSONObject json = JSONUtil.parseObj(result);
        String prepayId = json.getStr("prepay_id");

        return WxPayUtils.buildPaySign(config.getAppId(), prepayId, config.getPrivateKey());
    }
}
```

## ğŸ’¸ å¾®ä¿¡é€€æ¬¾æ¥å£

```java
@PostMapping("/wx/refund")
public ApiResponse<?> refund(@RequestBody RefundRequest req) {
    return ApiResponse.success(wxPayService.refund(req));
}
```

```java
public Map<String, Object> refund(RefundRequest req) {
    String url = "https://api.mch.weixin.qq.com/v3/refund/domestic/refunds";

    Map<String, Object> body = new HashMap<>();
    body.put("out_trade_no", req.getOrderNo());
    body.put("out_refund_no", req.getRefundNo());
    body.put("reason", "ç”¨æˆ·å–æ¶ˆè®¢å•");
    body.put("notify_url", config.getRefundNotifyUrl());

    Map<String, Object> amount = new HashMap<>();
    amount.put("refund", req.getRefundAmount());
    amount.put("total", req.getTotalAmount());
    amount.put("currency", "CNY");

    body.put("amount", amount);

    String result = WxPayUtils.v3Post(url, body, config);
    return JSONUtil.parseObj(result);
}
```

## ğŸ§  å·¥å…·ç±» WxPayUtilsï¼ˆç®€åŒ–å°è£…ï¼‰

ä½ éœ€è¦å°è£…ä»¥ä¸‹å‡ ä¸ªåŠŸèƒ½ï¼š

* âœ… v3 æ¥å£çš„ç­¾åå’Œè¯·æ±‚
* âœ… prepay\_id è½¬ä¸ºå‰ç«¯æ”¯ä»˜å‚æ•°
* âœ… è§£å¯†å›è°ƒæ•°æ®ï¼ˆé€€æ¬¾ç»“æœé€šçŸ¥ï¼‰

å»ºè®®å‚è€ƒå®˜æ–¹ v3 SDK æˆ–ä½¿ç”¨è½»é‡å¼€æºåº“å¦‚ [wechatpay-apiv3](https://github.com/wechatpay-apiv3/wechatpay-apache-httpclient)

## âœ… å°ç»“

| åŠŸèƒ½      | çŠ¶æ€ | å¤‡æ³¨                                     |
| --------- | ---- | ---------------------------------------- |
| ç™»å½•/æ³¨å†Œ | âœ…    | wx.login + åç«¯æ¢å– openid               |
| å‘èµ·æ”¯ä»˜  | âœ…    | æ”¯æŒ JSAPI                               |
| é€€æ¬¾å¤„ç†  | âœ…    | V3 æ¥å£                                  |
| å®æ—¶å›è°ƒ  | âœ…    | æ”¯ä»˜å›è°ƒã€é€€æ¬¾å›è°ƒè¦é…ç½®æ¥å£ã€è§£å¯†ã€éªŒç­¾ |

# å¾®ä¿¡å·¥å…·ç±»çš„è®¾è®¡å‚è€ƒ


ä¸‹é¢æ˜¯ä¸€ä¸ªå®Œæ•´å®è·µä¸­å¸¸è§çš„ `WxPayUtils` å·¥å…·ç±»è®¾è®¡ï¼Œä¸»è¦ç”¨äºï¼š

* å¾®ä¿¡æ”¯ä»˜ç­¾åç”Ÿæˆ
* ç»Ÿä¸€ä¸‹å•å‚æ•°æ„å»º
* å›è°ƒé€šçŸ¥ç­¾åéªŒè¯
* XML/Map è½¬æ¢å¤„ç†ï¼ˆå¾®ä¿¡æ”¯ä»˜ V2ï¼‰

ï¼ˆæ³¨ï¼šè‹¥ä½¿ç”¨å¾®ä¿¡æ”¯ä»˜ V3ï¼Œè¿™éƒ¨åˆ†ä¼šä¸åŒï¼Œéœ€è¦ä½¿ç”¨å¾®ä¿¡æä¾›çš„ SDK å’Œè¯ä¹¦åŠ å¯†ï¼‰

## 1. ä¾èµ–é…ç½®

```xml
<!-- fastxmlï¼ˆxml å’Œ map è½¬æ¢ï¼‰ -->
<dependency>
    <groupId>com.fasterxml.jackson.dataformat</groupId>
    <artifactId>jackson-dataformat-xml</artifactId>
</dependency>

<!-- apache commons-lang -->
<dependency>
    <groupId>org.apache.commons</groupId>
    <artifactId>commons-lang3</artifactId>
</dependency>

<!-- hutool å·¥å…·åŒ…ï¼ˆå¯é€‰ï¼‰ -->
<dependency>
    <groupId>cn.hutool</groupId>
    <artifactId>hutool-all</artifactId>
</dependency>
```

## 2. å·¥å…·ç±»è®¾è®¡ç¤ºä¾‹

```java
package com.example.utils;

import cn.hutool.core.util.RandomUtil;
import cn.hutool.crypto.digest.DigestUtil;
import com.fasterxml.jackson.dataformat.xml.XmlMapper;
import org.apache.commons.lang3.StringUtils;

import java.io.IOException;
import java.lang.reflect.Field;
import java.util.*;

/**
 * å¾®ä¿¡æ”¯ä»˜å·¥å…·ç±»ï¼ˆé€‚ç”¨äºå¾®ä¿¡æ”¯ä»˜V2ï¼‰
 */
public class WxPayUtils {

    private static final XmlMapper xmlMapper = new XmlMapper();

    /**
     * ç”Ÿæˆå¸¦ç­¾åçš„è¯·æ±‚å‚æ•°ï¼ˆç”¨äºç»Ÿä¸€ä¸‹å•ï¼‰
     */
    public static Map<String, String> buildSignedRequest(Map<String, String> params, String apiKey) {
        params.put("nonce_str", RandomUtil.randomString(32));
        String sign = createSign(params, apiKey);
        params.put("sign", sign);
        return params;
    }

    /**
     * åˆ›å»ºç­¾åï¼ˆMD5æ–¹å¼ï¼‰
     */
    public static String createSign(Map<String, String> data, String apiKey) {
        // 1. å‚æ•°æ’åº
        SortedMap<String, String> sortedMap = new TreeMap<>(data);
        StringBuilder sb = new StringBuilder();

        for (Map.Entry<String, String> entry : sortedMap.entrySet()) {
            if (StringUtils.isNotBlank(entry.getValue()) && !"sign".equals(entry.getKey())) {
                sb.append(entry.getKey()).append("=").append(entry.getValue()).append("&");
            }
        }

        sb.append("key=").append(apiKey);
        // 2. MD5åŠ å¯†å¹¶è½¬å¤§å†™
        return DigestUtil.md5Hex(sb.toString()).toUpperCase();
    }

    /**
     * éªŒè¯å›è°ƒå‚æ•°ç­¾åæ˜¯å¦æ­£ç¡®
     */
    public static boolean isSignValid(Map<String, String> data, String apiKey) {
        if (!data.containsKey("sign")) return false;
        String sign = data.get("sign");
        return sign.equals(createSign(data, apiKey));
    }

    /**
     * Map -> XML
     */
    public static String mapToXml(Map<String, String> data) {
        try {
            return xmlMapper.writeValueAsString(data);
        } catch (IOException e) {
            throw new RuntimeException("mapToXml error", e);
        }
    }

    /**
     * XML -> Map
     */
    public static Map<String, String> xmlToMap(String xml) {
        try {
            return xmlMapper.readValue(xml, Map.class);
        } catch (IOException e) {
            throw new RuntimeException("xmlToMap error", e);
        }
    }

    /**
     * æ„é€ åŸºç¡€è¯·æ±‚å‚æ•°
     */
    public static Map<String, String> baseRequest(String appId, String mchId, String notifyUrl) {
        Map<String, String> map = new HashMap<>();
        map.put("appid", appId);
        map.put("mch_id", mchId);
        map.put("notify_url", notifyUrl);
        map.put("nonce_str", RandomUtil.randomString(32));
        map.put("sign_type", "MD5");
        return map;
    }
}
```

## 3. ç”¨æ³•ä¸¾ä¾‹ï¼ˆç»Ÿä¸€ä¸‹å•ï¼‰

```java
Map<String, String> params = WxPayUtils.baseRequest(APPID, MCHID, NOTIFY_URL);
params.put("body", "æµ‹è¯•å•†å“");
params.put("out_trade_no", orderNo);
params.put("total_fee", "1"); // å•ä½ï¼šåˆ†
params.put("spbill_create_ip", "127.0.0.1");
params.put("trade_type", "JSAPI");
params.put("openid", userOpenId);

// ç­¾å & å‘é€
Map<String, String> signedParams = WxPayUtils.buildSignedRequest(params, API_KEY);
String requestXml = WxPayUtils.mapToXml(signedParams);
String resultXml = HttpUtils.post(WX_PAY_UNIFIED_ORDER_URL, requestXml);

// å“åº”å¤„ç†
Map<String, String> resultMap = WxPayUtils.xmlToMap(resultXml);
if (!"SUCCESS".equals(resultMap.get("return_code")) || !"SUCCESS".equals(resultMap.get("result_code"))) {
    throw new RuntimeException("å¾®ä¿¡ç»Ÿä¸€ä¸‹å•å¤±è´¥: " + resultMap.get("return_msg"));
}
```

## 4. å¸¸è§å›è°ƒéªŒç­¾å¤„ç†

```java
@PostMapping("/wxpay/notify")
public String handleWxPayNotify(HttpServletRequest request) throws IOException {
    String xml = IOUtils.toString(request.getInputStream(), "UTF-8");
    Map<String, String> notifyData = WxPayUtils.xmlToMap(xml);

    if (!"SUCCESS".equals(notifyData.get("result_code"))) {
        return WxPayUtils.mapToXml(Map.of("return_code", "FAIL", "return_msg", "æ”¯ä»˜å¤±è´¥"));
    }

    boolean valid = WxPayUtils.isSignValid(notifyData, API_KEY);
    if (!valid) {
        return WxPayUtils.mapToXml(Map.of("return_code", "FAIL", "return_msg", "ç­¾åæ— æ•ˆ"));
    }

    // å¤„ç†è®¢å•çŠ¶æ€æ›´æ–°ä¸šåŠ¡...
    
    return WxPayUtils.mapToXml(Map.of("return_code", "SUCCESS", "return_msg", "OK"));
}
```

> å¦‚æœç”¨çš„æ˜¯å¾®ä¿¡æ”¯ä»˜ V3ï¼ˆæ›´å®‰å…¨ï¼Œæ¨èï¼‰ï¼Œä¼šæ¶‰åŠè¯ä¹¦ç­¾åã€V3 SDKã€HTTP è¯·æ±‚å¤´æ ¡éªŒæœºåˆ¶ç­‰ï¼Œé€»è¾‘å¤æ‚ä¸å°‘ã€‚å¦‚æœé¡¹ç›®åç»­æœ‰è¿™ä¸ªæ–¹å‘çš„éœ€æ±‚ï¼Œä¹Ÿå¯ä»¥ä¸“é—¨æ„å»ºä¸€ç‰ˆ V3 ä¸“ç”¨å·¥å…·ç±»ã€‚