# æœ€ä½³å®è·µ - å‚æ•°æ ¡éªŒ

<img src="https://cdn.jsdelivr.net/gh/01Petard/imageURL@main/img/202501101245046.png" alt="image-20250110124552934" style="zoom:50%;" />

## åŸºæœ¬åŸåˆ™

- âŒ é¿å…è®°å½•é‡å¤ã€æ— æ„ä¹‰çš„æ—¥å¿—ï¼Œç¡®ä¿æ¯ä¸€æ¡æ—¥å¿—éƒ½æœ‰åŠ©äºè°ƒè¯•
- ğŸ”„ é¿å…åœ¨å¾ªç¯ä¸­ä½¿ç”¨æ—¥å¿—ï¼Œä»¥å…äº§ç”Ÿå¤§é‡å†—ä½™æ•°æ®
- ğŸ“˜ åªè®°å½•å¿…è¦çš„å‚æ•°ï¼Œè€Œä¸æ˜¯å®Œæ•´çš„å¯¹è±¡ç»“æ„

## é£é™©é˜²èŒƒ

- ğŸŒ å°†è‹±æ–‡ä½œä¸ºæ—¥å¿—è¯­è¨€ï¼Œä»¥é¢„é˜²ç¼–ç é—®é¢˜
- ğŸ”¨ ä¸æ»¥ç”¨Errorçº§åˆ«çš„æ—¥å¿—ï¼Œå‡è½»ç´§æ€¥å“åº”è´Ÿæ‹…

- ğŸš« ä¸è¦åœ¨æ—¥å¿—è®°å½•è¿‡ç¨‹ä¸­é˜»æ–­ä¸šåŠ¡æµç¨‹

  ###### é”™è¯¯æ–¹å¼

  ä¸è¦ç”¨å¯èƒ½ä¼šå‘ç”Ÿç©ºæŒ‡é’ˆå¼‚å¸¸çš„å¯¹è±¡æˆ–æ–¹æ³•

  ```java
  public void createShop(Shop shop){
  	log.info("create and print log: {}", shop.getName().toLowerCase());
  }
  ```

## æ€§èƒ½ä¿éšœ

- ğŸ’¡ ä½¿ç”¨ä¸“ç”¨æ—¥å¿—åº“ï¼Œè€Œéæ ‡å‡†è¾“å‡ºï¼Œæ¥æé«˜æ€§èƒ½å¹¶ä¾¿äºç®¡ç†

  ###### é”™è¯¯æ–¹å¼

  ```java
  public void love() {
      System.out.println("i love java...");
      // ä¸šåŠ¡é€»è¾‘
      ...
  }
  ```

  ###### åŸå› ï¼šprintln å†…éƒ¨å®ç°æ˜¯å¸¦é”çš„

  ```java
  public void println(boolean x) {
      synchronized (this) {
          print(x);
          newLine();
      }
  }
  ```

  ##### æ­£ç¡®æ–¹å¼

  ```java
  public void love() {
      log.info("i love java...");
      // ä¸šåŠ¡é€»è¾‘
      ...
  }
  ```

- ğŸ”’ ç»Ÿä¸€æ—¥å¿—æ¡†æ¶å‡å°‘ä¾èµ–è€¦åˆï¼Œæå‡ç»´æŠ¤ä¾¿åˆ©æ€§

  ç¦ç”¨`Log4j`æˆ–`LogBack`çš„APIè¾“å‡ºæ—¥å¿—ï¼Œè€Œæ˜¯ç”¨`Slf4j`ï¼Œé˜²æ­¢ä»£ç å’Œæ—¥å¿—å¼ºè€¦åˆ

  ```java
  // ç›´æ¥ä½¿ç”¨
  @Slf4j
  public class Test {}
  
  // æˆ–è€…ç›´æ¥å¼•å…¥
  import org.slf4j.Logger;
  import org.slf4j.LoggerFactory;
  
  private static final Logger log = LoggerFactory.getLogger(xxx.class);
  ```

- âš™ï¸ æ ¹æ®æ—¥å¿—çº§åˆ«æ§åˆ¶è¾“å‡ºï¼Œé˜²æ­¢ä¸å¿…è¦çš„èµ„æºè€—è´¹

  ##### é”™è¯¯æ–¹å¼

  ```java
  public void hello(String name) {
      log.trace("trace hello" + name);
      log.debug("debug hello" + name);
      log.info("info hello" + name);
      // ä¸šåŠ¡é€»è¾‘
      ...
  }
  ```

  ##### æ­£ç¡®æ–¹å¼

  å¼ºçƒˆå»ºè®®ä½¿ç”¨å ä½ç¬¦æ¥è¾“å‡ºå†…å®¹ï¼Œé˜²æ­¢æ‰§è¡Œå­—ç¬¦ä¸²æ‹¼æ¥æ“ä½œï¼Œæµªè´¹ç³»ç»Ÿèµ„æº

  ```java
  public void hello() {
      if (log.isTraceEnabled()) {
          log.trace("trace hello {}", name);
      }
      if (log.isDebugEnabled()) {
          log.debug("debug hello {}", name);
      }
      if (log.isInfoEnabled()) {
          log.info("info hello {}", name);
      }
      // ä¸šåŠ¡é€»è¾‘
      ...
  }
  ```

- ğŸ‘¾ é”™è¯¯åœ°ä½¿ç”¨`e.printStackTrace()`ï¼Œå¯èƒ½å¯¼è‡´ä¸¥é‡çš„èµ„æºè€—å°½

  ###### é”™è¯¯æ–¹å¼

  ```java
  public void hello() {
      try {
          // ä¸šåŠ¡é€»è¾‘
          ...
      } catch (Exception e) {
          e.printStackTrace();
      }
  }
  ```

  ###### åŸå› ï¼š`e.printStackTrace()`ä¼šå°†äº§ç”Ÿçš„å­—ç¬¦ä¸²å­˜æ”¾åˆ°å­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œé™ä½å¯ç”¨å†…å­˜ç©ºé—´

  ```java
  public void printStackTrace() {
      printStackTrace(System.err);
  }
  ```

  ##### æ­£ç¡®æ–¹å¼

  ```java
  public void hello() {
      try {
          // ä¸šåŠ¡é€»è¾‘
          ...
      } catch (Exception e) {
          log.error("execute failed", e);
      }
  }
  ```

- ğŸ› åœ¨æ—¥å¿—ä¸­ç¦ç”¨å¤æ‚å¯¹è±¡åºåˆ—åŒ–ä»¥é˜²æ½œåœ¨é£é™©

  ###### é”™è¯¯æ–¹å¼

  ç¦æ­¢ä½¿ç”¨JSONåºåˆ—åŒ–å·¥å…·ï¼Œè¿™äº›å·¥å…·æ˜¯é€šè¿‡è°ƒç”¨å¯¹è±¡çš„getæ–¹æ³•å°†å¯¹è±¡è¿›è¡Œåºåˆ—åŒ–çš„ï¼Œå¦‚æœå¯¹è±¡çš„getæ–¹æ³•è¢«é‡å†™åˆ™å¯èƒ½ä¼šé¢ä¸´æŠ›å‡ºå¼‚å¸¸çš„é£é™©

  ```java
  public void hello(Object data) {
      log.info("print log, data={}", JSON.toJSONString(data));
      // ä¸šåŠ¡é€»è¾‘
      ...
  }
  ```

  ##### æ­£ç¡®æ–¹å¼

  æ¨èè‡ªå®šä¹‰toString æ–¹æ³•

  ```java
  public void hello() {
      log.info("hello and print log, data={}", data);
  }
  ```

## å¼€å‘ç®€åŒ–

- ğŸ•µï¸â€â™‚ï¸ æä¾›è¯¦ç»†å¼‚å¸¸ä¿¡æ¯æœ‰åŠ©äºé—®é¢˜è¿½è¸ª

  ###### é”™è¯¯æ–¹å¼

  ```java
  public void hello() {
      try {
          // ä¸šåŠ¡é€»è¾‘
          ...
      } catch (Exception e) {
          // æ²¡æœ‰æ‰“å°å¼‚å¸¸ eï¼Œæ— æ³•å®šä½å‡ºç°ä»€ä¹ˆç±»å‹çš„å¼‚å¸¸
          log.error("execute failed");
          // æ²¡æœ‰è®°å½•è¯¦ç»†çš„å †æ ˆå¼‚å¸¸ä¿¡æ¯ï¼Œåªè®°å½•é”™è¯¯åŸºæœ¬æè¿°ä¿¡æ¯ï¼Œä¸åˆ©äºæ’æŸ¥é—®é¢˜
          log.error("execute failed", e.getMessage());
      }
  }
  ```

  ##### æ­£ç¡®æ–¹å¼

  ```java
  public void hello() {
      try {
          // ä¸šåŠ¡é€»è¾‘
          ...
      } catch (Exception e) {
          log.error("execute failed", e);
      }
  }
  ```

- ğŸ’¼ è®°å½•å…³é”®å‡½æ•°çš„è¾“å…¥/è¾“å‡ºï¼Œå¢å¼ºæ’é”™èƒ½åŠ›

  ```java
  public String doSth(String id, String type) {
      log.info("start: {}, {}", id, type);        // å…¥å£å¤„è®°å½•åˆå§‹å€¼
      String res = process(id, type);
      log.info("end: {}, {}, {}", id, type, res); // å‡ºå£å¤„è®°å½•ç»“æœ
  }
  ```

- ğŸ¤ åˆ©ç”¨æ¡ä»¶è¯­å¥å‰åçš„æ—¥å¿—ï¼Œç®€åŒ–ç¨‹åºè·Ÿè¸ª

  ```java
  public void doSth() {
      ...
      if (user.isVip()) {
          log.info("vip member, Id: {}, start vip", userId());
          // ä¼šå‘˜é€»è¾‘
      } else {
          log.info("è¯¥ç”¨æˆ·æ˜¯éä¼šå‘˜, Id: {}, å¼€å§‹å¤„ç†éä¼šå‘˜é€»è¾‘", userId());
          // éä¼šå‘˜é€»è¾‘
      }
      ...
  }
  ```

- ğŸ“ æ·»åŠ Trace IDç”¨äºå…³è”ç›¸å…³äº‹ä»¶æµï¼Œä¸²è”ä¸€æ¬¡æ€§çš„æ—¥å¿—é“¾è·¯

  ```java
  import javax.servlet.ServletResponse;
  import javax.servlet.http.HttpServletRequest;
  import java.io.IOException;
  import java.util.UUID;
  
  @Component
  public class MDCCFilter implements Filter {
  
      private static final String TRACE_ID = "traceId";
  
      @Override
      public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
              throws IOException, javax.servlet.ServletException {
          try {
              // ä¸ºæ¯ä¸ªè¯·æ±‚ç”Ÿæˆå”¯ä¸€çš„ Trace ID
              String traceId = UUID.randomUUID().toString();
              MDC.put(TRACE_ID, traceId);
  
              // å¦‚æœéœ€è¦ï¼Œå¯ä»¥ä»è¯·æ±‚ä¸­æå–æ›´å¤šä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä¾‹å¦‚ç”¨æˆ· ID
              if (request instanceof HttpServletRequest) {
                  HttpServletRequest httpRequest = (HttpServletRequest) request;
                  String userId = httpRequest.getHeader("X-User-Id"); // å‡è®¾ç”¨æˆ· ID åœ¨è¯·æ±‚å¤´ä¸­
  
                  if (userId != null) {
                      MDC.put("userId", userId);
                  }
              }
  
              // æ‰§è¡Œåç»­çš„ Filter é“¾
              chain.doFilter(request, response);
          } finally {
              // æ¸…ç† MDCï¼Œé¿å…çº¿ç¨‹æ•°æ®æ±¡æŸ“
              MDC.clear();
          }
      }
  }
  
  // æ—¥å¿—æ ¼å¼
  %d{yyyy-MM-dd HH:mm:ss} [%thread] [%X{traceId}]
  %logger{36} - %msg%n
  ...
  ```
