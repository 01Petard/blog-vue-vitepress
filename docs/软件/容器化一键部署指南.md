# 🚀 容器化一键部署指南

以下文档将通过 Docker 快速搭建 **MySQL**、**Redis**、**Java 后端** 和 **Nginx**（静态资源 + 反向代理）的完整环境。

## 🐳 零、docker命令补充

| 操作         | 命令                                |
| ------------ | ----------------------------------- |
| 启动服务     | `docker-compose up -d`              |
| 停止服务     | `docker-compose down`               |
| 查看日志     | `docker-compose logs -f`            |
| 重建服务     | `docker-compose up --build -d`      |
| 删除所有容器 | `docker rm -f $(docker ps -aq)`     |
| 删除所有镜像 | `docker rmi -f $(docker images -q)` |

## 📂 一、目录结构规范及说明

所有文件放在同一项目根目录

```
your-project/
├── app.jar                # 后端打包好的 Java 应用
├── dist/                  # 前端构建产物
│   └── index.html
├── nginx/
│   └── conf.d/
│       └── default.conf   # Nginx 配置（静态 + /api 代理）
├── docker-compose.yml     # Docker Compose 编排配置
└── setup.sh               # 一键初始化脚本
```

目录结构说明

| 文件/目录                   | 作用                                                   |
| --------------------------- | ------------------------------------------------------ |
| `app.jar`                   | Java 后端打包包，挂载到容器 `/app.jar`                 |
| `dist/`                     | 前端静态资源目录，映射到 Nginx `/usr/share/nginx/html` |
| `nginx/conf.d/default.conf` | Nginx 配置，负责静态托管和 `/api` 代理                 |
| `docker-compose.yml`        | 定义各服务：MySQL、Redis、Java、Nginx                  |
| `setup.sh`                  | 自动生成目录、配置和 `docker-compose.yml`              |

## 📝 二、核心配置

### 1. `docker-compose.yml`

**必须要修改**的是mysql和redis的密码，其他的可以不改

```yaml
version: '1.0'

services:
  mysql:
    image: mysql:8.0.32
    container_name: mysql
    restart: always
    command: --default-authentication-plugin=mysql_native_password
    environment:
      TZ: Asia/Shanghai
      MYSQL_ROOT_PASSWORD: "123456"
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql

  redis:
    image: redis:7.2.0
    container_name: redis
    restart: always
    command: redis-server --requirepass "123456"
    volumes:
      - redis_data:/data

  java-app:
    image: openjdk:8-jdk
    container_name: java-app
    restart: always
    ports:
      - "8080:8080"
    depends_on: [mysql, redis]
    volumes:
      - ./app.jar:/app.jar
    command: |
      java -Xmx3g -Xms3g \
           -XX:+UseG1GC \
           -jar /app.jar

  nginx:
    image: nginx:1.25.3
    container_name: nginx
    restart: always
    depends_on: [java-app]
    ports:
      - "80:80"
    volumes:
      - ./dist:/usr/share/nginx/html
      - ./nginx/conf.d:/etc/nginx/conf.d

volumes:
  mysql_data:
  redis_data:
```

### 2. `nginx/conf.d/default.conf`

**仅作举例说明**，请以开发的配置为准

```nginx
server {
    listen 80;
    server_name localhost;

    # 前端页面
    location / {
        root /usr/share/nginx/html;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # 后端 API
    location /api/ {
        proxy_pass http://java-app:8080/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

## ⚙️ 三、nginx配置初始化脚本

该脚本将自动：

- 创建前端和 nginx 配置目录
- 自动生成 `nginx/conf.d/default.conf`

```bash
#!/usr/bin/env bash
set -e

PROJECT_ROOT="$(pwd)"
echo "📁 项目根目录：${PROJECT_ROOT}"

# 创建nginx的配置目录
mkdir -p nginx/conf.d

# 生成 nginx 配置
cat > nginx/conf.d/default.conf <<'EOF'


【【【将nginx的配置复制到这里】】】


EOF

echo "✅ 已生成 nginx/conf.d/default.conf"

# 提示后续操作
cat <<EOF

🎉 初始化完成，请按以下步骤继续：

1. 将后端 jar 包放到项目根目录：
   cp /tmp/app.jar ${PROJECT_ROOT}/app.jar

2. 将前端打包文件放入 dist/ 目录：
   cp -r /tmp/dist/* ${PROJECT_ROOT}/dist/

3. 启动服务：
   docker-compose up -d

4. 停止并清理资源：
   docker-compose down -v

🌐 访问：
- http://localhost/app_endpoint

EOF
```